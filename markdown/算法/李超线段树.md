# [李超线段树](../index.html)

## 问题引入

在一个平面直角坐标系中，需要在线维护两种操作。

- 加入一条线段
- 给出对于一条直线$x=a$求所有与之相交的线段中交点最高（或低）的一条

[![image1](https://z1.ax1x.com/2023/09/20/pPIeqG8.md.png)](https://imgse.com/i/pPIeqG8)

如图，红线$y=x+2 (1 \leq x \leq 4)$,蓝线$y=2x+1 (-1 \leq x \leq 5)$和紫线$y=9 (0 \leq x \leq 2)$为加入的三条线段，现在查询为绿线$x=3$，在与绿线有交点的线段中蓝线交点最高，所以答案为蓝线。

## 李超线段树

对于每一个区间，我们维护$x=mid$的答案，并且标记永久化。

何为标记永久化，简单地说就是标记不需要下传到儿子节点（也没有好的办法下传），正因如此，查询操作也会有所变化（后文会提到）。

### 插入操作

如果需要修改的区间不会覆盖整一个区间，那么我们就像普通线段树一样递归到儿子节点。

如果需要修改的区间覆盖了整一个区间，那么我们做以下三步：

1. 假设原来的优势线段为$y_1$，插入的线段为$y_2$，如果$x=mid$处$y_2$更优，那么我们**交换**，$y_1$和$y_2$
2. 如果在区间左端点处$y_2$（交换后的）更优，那么$y_1$与$y_2$的交点一定在左侧，所以递归左儿子
3. 如果在区间右端点处$y_2$（交换后的）更优，那么$y_1$与$y_2$的交点一定在右侧，所以递归右儿子

一个常见的疑问：为什么一定是**交换**$y_1$和$y_2$而不是**赋值**？

因为我们交换了$y_1$与$y_2$之后，尽管目前的$y_1$在$x=mid$更优，但是对于子区间不一定比$y_2$更优。

[![image2](https://z1.ax1x.com/2023/09/20/pPIeLRS.md.png)](https://imgse.com/i/pPIeLRS)

这是一个简单的反例，当前的区间为$[0,4]$。

### 查询操作

因为我们使用了标记永久化，所以查询时需要找到元区间$[a,a]$，然后将其的所有祖先区间的优势线段在$x=a$处进行比较，找出最优的线段。

### 时间空间复杂度分析
插入操作时间复杂度为$log^2n$，查询操作时间复杂度为$logn$，总空间复杂度为$n$

## 代码实现及注意事项

[code](https://www.luogu.com.cn/record/125355450)

值得注意的是`double`可能存在精度误差，所以请注意消除。

## 习题及运用

- [LG-4097](https://www.luogu.com.cn/problem/P4097)
- [LG-4254](https://www.luogu.com.cn/problem/P4254)

部分数据较简单的斜率优化DP也可以用李超线段树解决

- [LG-3195](https://www.luogu.com.cn/problem/P3195)